// -------------------------------------------------------------
// Real Estate CRM - Complete Schema
// -------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------------------------------------------------
// üè¢ Department Model
// -------------------------------------------------------------
model Department {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  roles     Role[]
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -------------------------------------------------------------
// üß© Role Model
// -------------------------------------------------------------
model Role {
  id           Int        @id @default(autoincrement())
  name         String
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id])
  users        User[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([name, departmentId])
  @@index([departmentId])
}

// -------------------------------------------------------------
// üë§ User Model
// -------------------------------------------------------------
model User {
  id       Int     @id @default(autoincrement())
  name     String
  email    String  @unique
  password String
  isActive Boolean @default(true)

  // Foreign keys
  departmentId Int?
  roleId       Int

  // Relations
  department Department? @relation(fields: [departmentId], references: [id])
  role       Role        @relation(fields: [roleId], references: [id])
  leads      Lead[]      @relation("UserLeads")

  // ADD THESE for new models
  deals      Deal[]     @relation("DealAssignedTo")
  activities Activity[] @relation("ActivityAssignedTo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([departmentId])
  @@index([roleId])
}

// -------------------------------------------------------------
// üß≤ Lead Model
// -------------------------------------------------------------
model Lead {
  id           Int     @id @default(autoincrement())
  name         String
  email        String?
  phone        String?
  status       String  @default("New")
  source       String?
  notes        String?
  assignedToId Int?

  // Relations
  assignedTo User? @relation("UserLeads", fields: [assignedToId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assignedToId])
  @@index([status])
}

// -------------------------------------------------------------
// üë• Contact Model
// -------------------------------------------------------------
model Contact {
  id     Int     @id @default(autoincrement())
  name   String
  email  String?
  phone  String?
  type   String  @default("buyer")
  budget Float?
  notes  String?

  // Relations
  dealsAsBuyer  Deal[]     @relation("DealBuyer")
  dealsAsSeller Deal[]     @relation("DealSeller")
  properties    Property[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -------------------------------------------------------------
// üè† Property Model
// -------------------------------------------------------------
model Property {
  id          Int     @id @default(autoincrement())
  title       String
  address     String
  price       Float?
  type        String?
  bedrooms    Int?
  bathrooms   Int?
  area        Int?
  status      String  @default("available")
  description String?

  // Relations
  deals   Deal[]
  ownerId Int?
  owner   Contact? @relation(fields: [ownerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([ownerId])
}

// -------------------------------------------------------------
// üíº Deal Model (PIPELINE CORE)
// -------------------------------------------------------------
model Deal {
  id    Int    @id @default(autoincrement())
  title String
  stage String @default("prospecting")

  // Relations
  buyerId      Int?
  sellerId     Int?
  propertyId   Int?
  assignedToId Int?

  buyer      Contact?   @relation("DealBuyer", fields: [buyerId], references: [id])
  seller     Contact?   @relation("DealSeller", fields: [sellerId], references: [id])
  property   Property?  @relation(fields: [propertyId], references: [id])
  assignedTo User?      @relation("DealAssignedTo", fields: [assignedToId], references: [id])
  activities Activity[]

  // Deal details
  offerPrice  Float?
  finalPrice  Float?
  commission  Float?
  closingDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([stage])
  @@index([assignedToId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([propertyId])
}

// -------------------------------------------------------------
// üìÖ Activity Model
// -------------------------------------------------------------
model Activity {
  id          Int       @id @default(autoincrement())
  type        String
  title       String
  description String?
  dueDate     DateTime?
  completed   Boolean   @default(false)

  // Relations
  dealId       Int
  deal         Deal  @relation(fields: [dealId], references: [id])
  assignedToId Int?
  assignedTo   User? @relation("ActivityAssignedTo", fields: [assignedToId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealId])
  @@index([assignedToId])
  @@index([dueDate])
}
